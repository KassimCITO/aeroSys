{% extends "base.html" %}
{% block title %}Vuelos{% endblock %}

{% block head %}
<script defer>
// Variables globales y funciones
var aeronaves = [];
var pilotos = [];
var canConfirmVuelos = false; // Variable para controlar permisos de confirmación

function showCreate() {
    resetForm();
    showFormWithTransition('formCard', 'Nuevo Vuelo');
    var saveBtn = document.querySelector('#formCard button.btn-success');
    if (saveBtn) saveBtn.onclick = saveVuelos;
}

// Sistema de notificaciones local (compatible con global)
function showMessage(message, type) {
    type = type || 'success';
    var alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';
    alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    
    // Buscar un contenedor válido para insertar el mensaje
    var container = document.querySelector('.container');
    var h3 = document.querySelector('h3');
    
    if (container && h3) {
        // Insertar después del h3
        container.insertBefore(alertDiv, h3.nextSibling);
    } else if (container) {
        // Si no hay h3, insertar al principio del contenedor
        container.insertBefore(alertDiv, container.firstChild);
    } else {
        // Fallback: insertar al principio del body
        document.body.insertBefore(alertDiv, document.body.firstChild);
    }
    
    setTimeout(function() { 
        if (alertDiv.parentNode) {
            alertDiv.remove(); 
        }
    }, 5000);
}

function validateForm() {
    var form = document.getElementById('vueloForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return false;
    }
    return true;
}

function resetForm() {
    var form = document.getElementById('vueloForm');
    form.reset();
    form.classList.remove('was-validated');
    // Establecer valores por defecto
    document.getElementById('estado').value = 'Programado';
    // Limpiar campos ocultos
    document.getElementById('vuelo_id').value = '';
}

function hideForm() {
    hideFormWithTransition('formCard');
    setTimeout(resetForm, 400);
}

function loadAeronaves() {
    return fetch('/api/aeronaves')
        .then(function(response) {
            if (!response.ok) throw new Error('Error al cargar aeronaves');
            return response.json();
        })
        .then(function(data) {
            aeronaves = data;
            
            // Poblar select del formulario
            var select = document.getElementById('aeronave_id');
            var currentValue = select.value;
            select.innerHTML = '<option value="">Seleccione una aeronave</option>';
            data.forEach(function(a) {
                var option = document.createElement('option');
                option.value = a.aeronave_id;
                option.textContent = a.matricula + ' - ' + a.modelo;
                select.appendChild(option);
            });
            if (currentValue && document.querySelector('#aeronave_id option[value="' + currentValue + '"]')) {
                select.value = currentValue;
            }
            
            // Poblar select de filtro
            var filtroSelect = document.getElementById('filtro_aeronave');
            var currentFiltroValue = filtroSelect.value;
            filtroSelect.innerHTML = '<option value="">Todas</option>';
            data.forEach(function(a) {
                var option = document.createElement('option');
                option.value = a.aeronave_id;
                option.textContent = a.matricula + ' - ' + a.modelo;
                filtroSelect.appendChild(option);
            });
            if (currentFiltroValue) {
                filtroSelect.value = currentFiltroValue;
            }
            
            return data;
        })
        .catch(function(error) {
            showMessage('Error al cargar aeronaves: ' + error.message, 'danger');
            throw error;
        });
}

function loadPilotos() {
    return fetch('/api/pilotos')
        .then(function(response) {
            if (!response.ok) throw new Error('Error al cargar pilotos');
            return response.json();
        })
        .then(function(data) {
            pilotos = data;
            
            // Poblar select de piloto del formulario
            var selectPiloto = document.getElementById('piloto_id');
            var currentPilotoValue = selectPiloto.value;
            selectPiloto.innerHTML = '<option value="">Seleccione un piloto</option>';
            
            // Poblar select de copiloto del formulario
            var selectCopiloto = document.getElementById('copiloto_id');
            var currentCopilotoValue = selectCopiloto.value;
            selectCopiloto.innerHTML = '<option value="">Seleccione un copiloto (opcional)</option>';
            
            // Poblar select de filtro
            var filtroSelect = document.getElementById('filtro_piloto');
            var currentFiltroValue = filtroSelect.value;
            filtroSelect.innerHTML = '<option value="">Todos</option>';
            
            data.forEach(function(p) {
                var optionPiloto = document.createElement('option');
                optionPiloto.value = p.piloto_id;
                optionPiloto.textContent = p.nombre + ' (' + p.licencia + ')';
                selectPiloto.appendChild(optionPiloto);
                
                var optionCopiloto = document.createElement('option');
                optionCopiloto.value = p.piloto_id;
                optionCopiloto.textContent = p.nombre + ' (' + p.licencia + ')';
                selectCopiloto.appendChild(optionCopiloto);
                
                var optionFiltro = document.createElement('option');
                optionFiltro.value = p.piloto_id;
                optionFiltro.textContent = p.nombre + ' (' + p.licencia + ')';
                filtroSelect.appendChild(optionFiltro);
            });
            
            if (currentPilotoValue && document.querySelector('#piloto_id option[value="' + currentPilotoValue + '"]')) {
                selectPiloto.value = currentPilotoValue;
            }
            if (currentCopilotoValue && document.querySelector('#copiloto_id option[value="' + currentCopilotoValue + '"]')) {
                selectCopiloto.value = currentCopilotoValue;
            }
            if (currentFiltroValue) {
                filtroSelect.value = currentFiltroValue;
            }
            
            return data;
        })
        .catch(function(error) {
            showMessage('Error al cargar pilotos: ' + error.message, 'danger');
            throw error;
        });
}

function fetchVuelos() {
    // Obtener valores de los filtros
    var estado = document.getElementById('filtro_estado').value;
    var aeronave_id = document.getElementById('filtro_aeronave').value;
    var piloto_id = document.getElementById('filtro_piloto').value;
    var fecha_desde = document.getElementById('filtro_fecha_desde').value;
    var fecha_hasta = document.getElementById('filtro_fecha_hasta').value;
    
    // Construir URL con filtros
    var url = '/api/vuelos?';
    var params = [];
    if (estado) params.push('estado=' + encodeURIComponent(estado));
    if (aeronave_id) params.push('aeronave_id=' + encodeURIComponent(aeronave_id));
    if (piloto_id) params.push('piloto_id=' + encodeURIComponent(piloto_id));
    if (fecha_desde) params.push('fecha_desde=' + encodeURIComponent(fecha_desde));
    if (fecha_hasta) params.push('fecha_hasta=' + encodeURIComponent(fecha_hasta));
    
    if (params.length > 0) {
        url += params.join('&');
    }

    fetch(url)
        .then(function(response) {
            if (!response.ok) throw new Error('Error al cargar vuelos');
            return response.json();
        })
        .then(function(data) {
            var tbody = document.getElementById('vuelosTable');
            if (tbody) {
                tbody.innerHTML = '';
                
                data.forEach(function(r) {
                    var aeronave = aeronaves.find(function(a) { return a.aeronave_id === r.id_aeronave; });
                    var piloto = pilotos.find(function(p) { return p.piloto_id === r.id_piloto; });
                    var copiloto = r.id_copiloto ? pilotos.find(function(p) { return p.piloto_id === r.id_copiloto; }) : null;
                    
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + r.codigo_vuelo + '</td>' +
                                  '<td>' + r.origen + '</td>' +
                                  '<td>' + r.destino + '</td>' +
                                  '<td>' + new Date(r.fecha_salida).toLocaleString() + '</td>' +
                                  '<td>' + (r.fecha_llegada ? new Date(r.fecha_llegada).toLocaleString() : '-') + '</td>' +
                                  '<td>' + (aeronave ? aeronave.matricula : r.id_aeronave) + '</td>' +
                                  '<td>' + (piloto ? piloto.nombre : r.id_piloto) + '</td>' +
                                  '<td>' + (copiloto ? copiloto.nombre : '-') + '</td>' +
                                  '<td>' + (r.observaciones || '-') + '</td>' +
                                  '<td>' +
                                  '<button class="btn btn-sm btn-warning" title="Editar" onclick="editV(' + r.id_vuelo + ')"><i class="fas fa-edit"></i></button> ' +
                                  '<button class="btn btn-sm btn-danger" title="Eliminar" onclick="delV(' + r.id_vuelo + ')"><i class="fas fa-trash"></i></button> ' +
                                  (canConfirmVuelos ? '<button class="btn btn-sm btn-success" onclick="confirmarVuelo(' + r.id_vuelo + ')" title="Confirmar Vuelo">' +
                                  '<i class="fas fa-check-circle"></i>' +
                                  '</button>' : '') +
                                  '</td>';
                    tbody.appendChild(tr);
                });
            }
        })
        .catch(function(error) {
            showMessage(error.message, 'danger');
        });
}

function saveVuelo() {
    if (!validateForm()) {
        showMessage('Por favor complete todos los campos requeridos', 'warning');
        return false;
    }

    var vuelo_id = document.getElementById('vuelo_id').value;
    var method = vuelo_id ? 'PUT' : 'POST';
    var url = '/api/vuelos' + (vuelo_id ? '/' + vuelo_id : '');

    var payload = {
        numero_vuelo: document.getElementById('numero_vuelo').value,
        origen: document.getElementById('origen').value,
        destino: document.getElementById('destino').value,
        fecha_salida: document.getElementById('fecha_salida').value,
        fecha_llegada: document.getElementById('fecha_llegada').value,
        aeronave_id: parseInt(document.getElementById('aeronave_id').value),
        piloto_id: parseInt(document.getElementById('piloto_id').value),
        copiloto_id: document.getElementById('copiloto_id').value ? parseInt(document.getElementById('copiloto_id').value) : null,
        estado: document.getElementById('estado').value,
        pasajeros: document.getElementById('pasajeros').value || null,
        observaciones: document.getElementById('observaciones').value || null
    };

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
    })
    .then(data => {
        // Si es un nuevo vuelo (POST), crear confirmación automáticamente
        if (!vuelo_id && data.id) {
            // Crear confirmación con valores por defecto
            return crearConfirmacionAutomatica(data.id, payload);
        } else {
            // Si es actualización, solo mostrar mensaje y refrescar
            hideForm();
            fetchVuelos();
            showMessage('Vuelo actualizado exitosamente', 'success');
        }
    })
    .catch(error => {
        showMessage('Error: ' + error.message, 'danger');
        console.error('Error:', error);
    });

    return false;
}

// Función para crear confirmación automáticamente después de crear un vuelo
function crearConfirmacionAutomatica(vueloId, vueloData) {
    var confirmacionPayload = {
        vuelo_id: vueloId,
        estado: 'Pendiente',
        notas: 'Confirmación creada automáticamente'
    };
    
    return fetch('/api/confirmaciones', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(confirmacionPayload)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
    })
    .then(confirmacionData => {
        // Ocultar formulario y refrescar tabla
        hideForm();
        fetchVuelos();
        
        // Mostrar mensaje de éxito
        showMessage('Vuelo y confirmación creados exitosamente', 'success');
        
        // Abrir modal de confirmación para que el usuario pueda revisar/editar
        abrirModalConfirmacionNueva(vueloId, vueloData, confirmacionData);
    })
    .catch(error => {
        // Si falla la confirmación, mostrar advertencia pero el vuelo ya fue creado
        showMessage('Vuelo creado, pero hubo un error al crear la confirmación: ' + error.message, 'warning');
        hideForm();
        fetchVuelos();
    });
}

function editV(id) {
    fetch('/api/vuelos/' + id)
        .then(function(response) {
            if (!response.ok) throw new Error('Error al cargar el vuelo');
            return response.json();
        })
        .then(function(data) {
            document.getElementById('numero_vuelo').value = data.codigo_vuelo;
            document.getElementById('origen').value = data.origen;
            document.getElementById('destino').value = data.destino;
            document.getElementById('fecha_salida').value = data.fecha_salida ? data.fecha_salida.substring(0, 16) : '';
            document.getElementById('fecha_llegada').value = data.fecha_llegada ? data.fecha_llegada.substring(0, 16) : '';
            document.getElementById('aeronave_id').value = data.id_aeronave;
            document.getElementById('piloto_id').value = data.id_piloto;
            document.getElementById('copiloto_id').value = data.id_copiloto || '';
            document.getElementById('estado').value = data.estado || 'Programado';
            document.getElementById('pasajeros').value = data.pasajeros || '';
            document.getElementById('observaciones').value = data.observaciones || '';
            
            document.getElementById('formTitle').textContent = 'Editar Vuelo (ID ' + id + ')';
            document.getElementById('formCard').style.display = 'block';
            
            document.querySelector('#formCard button.btn-primary').onclick = function() {
                if (!validateForm()) return;
                
                var payload = {
                    codigo_vuelo: document.getElementById('numero_vuelo').value,
                    origen: document.getElementById('origen').value,
                    destino: document.getElementById('destino').value,
                    fecha_salida: document.getElementById('fecha_salida').value,
                    fecha_llegada: document.getElementById('fecha_llegada').value || null,
                    id_aeronave: parseInt(document.getElementById('aeronave_id').value),
                    id_piloto: parseInt(document.getElementById('piloto_id').value),
                    id_copiloto: document.getElementById('copiloto_id').value ? parseInt(document.getElementById('copiloto_id').value) : null,
                    estado: document.getElementById('estado').value,
                    pasajeros: document.getElementById('pasajeros').value || null,
                    observaciones: document.getElementById('observaciones').value || null
                };
                
                fetch('/api/vuelos/' + id, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                })
                .then(function(response) {
                    if (!response.ok) throw new Error('Error al actualizar el vuelo');
                    // Hide form and refresh table immediately
                    hideForm();
                    fetchVuelos();
                    showMessage('Vuelo actualizado exitosamente', 'success');
                })
                .catch(function(error) {
                    showMessage(error.message, 'danger');
                });
            };
        })
        .catch(function(error) {
            showMessage(error.message, 'danger');
        });
}

function delV(id) {
    if (!confirm('¿Está seguro que desea eliminar el vuelo #' + id + '?')) return;
    
    fetch('/api/vuelos/' + id, {method: 'DELETE'})
        .then(function(response) {
            if (!response.ok) throw new Error('Error al eliminar el vuelo');
            showMessage('Vuelo eliminado exitosamente');
            fetchVuelos();
        })
        .catch(function(error) {
            showMessage(error.message, 'danger');
        });
}

function init() {
    // Cargar datos iniciales
    loadAeronaves();
    loadPilotos();
    fetchVuelos();
    checkUserPermissions();

    // Agregar evento submit al formulario
    document.getElementById('vueloForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveVuelo();
    });
}

function checkUserPermissions() {
    // Verificar si el usuario puede confirmar vuelos
    // Los pilotos e invitados no pueden confirmar vuelos
    fetch('/api/usuario-actual')
        .then(function(response) {
            if (!response.ok) throw new Error('Error al verificar permisos');
            return response.json();
        })
        .then(function(user) {
            // Solo operadores autorizados (admin, operador) pueden confirmar vuelos
            canConfirmVuelos = !['piloto', 'invitado'].includes(user.rol);
        })
        .catch(function(error) {
            console.error('Error al verificar permisos:', error);
            canConfirmVuelos = false;
        });
}

// Funciones para filtros y exportación
function aplicarFiltros() {
    // Simplemente recargar la tabla con los filtros actuales
    fetchVuelos();
}

function exportarPDF() {
    var estado = document.getElementById('filtro_estado').value;
    var aeronave_id = document.getElementById('filtro_aeronave').value;
    var piloto_id = document.getElementById('filtro_piloto').value;
    var fecha_desde = document.getElementById('filtro_fecha_desde').value;
    var fecha_hasta = document.getElementById('filtro_fecha_hasta').value;
    
    // Construir URL con filtros
    var url = '/reports/vuelos?';
    var params = [];
    if (estado) params.push('estado=' + encodeURIComponent(estado));
    if (aeronave_id) params.push('aeronave_id=' + encodeURIComponent(aeronave_id));
    if (piloto_id) params.push('piloto_id=' + encodeURIComponent(piloto_id));
    if (fecha_desde) params.push('fecha_desde=' + encodeURIComponent(fecha_desde));
    if (fecha_hasta) params.push('fecha_hasta=' + encodeURIComponent(fecha_hasta));
    
    if (params.length > 0) {
        url += params.join('&');
    }
    
    // Descargar PDF
    window.location.href = url;
}

function exportarExcel() {
    var estado = document.getElementById('filtro_estado').value;
    var aeronave_id = document.getElementById('filtro_aeronave').value;
    var piloto_id = document.getElementById('filtro_piloto').value;
    var fecha_desde = document.getElementById('filtro_fecha_desde').value;
    var fecha_hasta = document.getElementById('filtro_fecha_hasta').value;
    
    // Construir URL con filtros
    var url = '/reports/vuelos?formato=excel';
    var params = [];
    if (estado) params.push('estado=' + encodeURIComponent(estado));
    if (aeronave_id) params.push('aeronave_id=' + encodeURIComponent(aeronave_id));
    if (piloto_id) params.push('piloto_id=' + encodeURIComponent(piloto_id));
    if (fecha_desde) params.push('fecha_desde=' + encodeURIComponent(fecha_desde));
    if (fecha_hasta) params.push('fecha_hasta=' + encodeURIComponent(fecha_hasta));
    
    if (params.length > 0) {
        url += '&' + params.join('&');
    }
    
    // Descargar Excel
    window.location.href = url;
}

// Función para confirmar vuelo
function confirmarVuelo(vueloId) {
    // Verificar si el usuario tiene permisos (no piloto ni invitado)
    // Esta verificación se puede hacer en el backend también
    fetch('/api/vuelos/' + vueloId)
        .then(function(response) {
            if (!response.ok) throw new Error('Error al cargar el vuelo');
            return response.json();
        })
        .then(function(vuelo) {
            // Cargar información del vuelo en el modal
            var aeronave = aeronaves.find(function(a) { return a.aeronave_id === vuelo.id_aeronave; });
            var piloto = pilotos.find(function(p) { return p.piloto_id === vuelo.id_piloto; });
            
            document.getElementById('vuelo_id_confirmar').value = vueloId;
            document.getElementById('vueloInfo').innerHTML = 
                '<div class="row">' +
                '<div class="col-md-6"><strong>Número de Vuelo:</strong><br>' + vuelo.codigo_vuelo + '</div>' +
                '<div class="col-md-6"><strong>Ruta:</strong><br>' + vuelo.origen + ' → ' + vuelo.destino + '</div>' +
                '</div>' +
                '<div class="row mt-2">' +
                '<div class="col-md-6"><strong>Fecha Salida:</strong><br>' + new Date(vuelo.fecha_salida).toLocaleString() + '</div>' +
                '<div class="col-md-6"><strong>Fecha Llegada:</strong><br>' + (vuelo.fecha_llegada ? new Date(vuelo.fecha_llegada).toLocaleString() : 'No programada') + '</div>' +
                '</div>' +
                '<div class="row mt-2">' +
                '<div class="col-md-6"><strong>Aeronave:</strong><br>' + (aeronave ? aeronave.matricula + ' - ' + aeronave.modelo : 'N/A') + '</div>' +
                '<div class="col-md-6"><strong>Piloto:</strong><br>' + (piloto ? piloto.nombre + ' (' + piloto.licencia + ')' : 'N/A') + '</div>' +
                '</div>';

            // Limpiar formulario
            document.getElementById('estado_confirmacion').value = '';
            document.getElementById('notas_confirmacion').value = '';
            
            // Limpiar atributo de confirmación existente
            document.getElementById('vuelo_id_confirmar').removeAttribute('data-confirmacion-id');
            
            // Mostrar modal
            var modal = new bootstrap.Modal(document.getElementById('confirmarVueloModal'));
            modal.show();
        })
        .catch(function(error) {
            showMessage('Error al cargar información del vuelo: ' + error.message, 'danger');
        });
}

// Función para guardar confirmación
function guardarConfirmacion() {
    var vueloId = document.getElementById('vuelo_id_confirmar').value;
    var estado = document.getElementById('estado_confirmacion').value;
    var notas = document.getElementById('notas_confirmacion').value;
    var confirmacionId = document.getElementById('vuelo_id_confirmar').getAttribute('data-confirmacion-id');
    
    if (!estado) {
        showMessage('Por favor seleccione un estado de confirmación', 'warning');
        return;
    }
    
    var payload = {
        vuelo_id: parseInt(vueloId),
        estado: estado,
        notas: notas
    };

    // Si ya existe una confirmación, actualizarla; si no, crear una nueva
    var method = confirmacionId ? 'PUT' : 'POST';
    var url = confirmacionId ? '/api/confirmaciones/' + confirmacionId : '/api/confirmaciones';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
    })
    .then(data => {
        showMessage('Confirmación guardada exitosamente', 'success');
        // Cerrar modal
        var modalElement = document.getElementById('confirmarVueloModal');
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            // If no instance exists, create one and hide it
            var newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
        // Recargar tabla de vuelos
        fetchVuelos();
    })
    .catch(error => {
        showMessage('Error al guardar confirmación: ' + error.message, 'danger');
        console.error('Error:', error);
    });
}


// =======================================
// FUNCIONES PARA MODALES DE CREACIÓN RÁPIDA
// =======================================

// Función para mostrar modal de agregar aeronave
function showAeronaveModal() {
    resetAeronaveModalForm();
    var modal = new bootstrap.Modal(document.getElementById('agregarAeronaveModal'));
    modal.show();
}

// Función para resetear formulario de aeronave modal
function resetAeronaveModalForm() {
    var form = document.getElementById('aeronaveModalForm');
    form.reset();
    form.classList.remove('was-validated');
    // Limpiar preview de imagen
    document.getElementById('modal_preview').style.display = 'none';
    document.getElementById('modal_image_preview').src = '';
}

// Función para validar formulario de aeronave modal
function validateAeronaveModalForm() {
    var form = document.getElementById('aeronaveModalForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return false;
    }
    return true;
}

// Función para guardar aeronave desde modal
function guardarAeronaveModal() {
    if (!validateAeronaveModalForm()) {
        showMessage('Por favor complete los campos requeridos correctamente', 'warning');
        return;
    }
    
    // Usar FormData para soportar archivos
    var formData = new FormData();
    formData.append('matricula', document.getElementById('modal_matricula').value.trim().toUpperCase());
    formData.append('modelo', document.getElementById('modal_modelo').value.trim());
    formData.append('fabricante', document.getElementById('modal_fabricante').value.trim() || '');
    formData.append('capacidad', document.getElementById('modal_capacidad').value || '0');
    formData.append('tipo_aeronave', document.getElementById('modal_tipo_aeronave').value || '');
    
    // Agregar imagen si fue seleccionada
    var imageFile = document.getElementById('modal_imagen').files[0];
    if (imageFile) {
        formData.append('imagen', imageFile);
    }
    
    fetch('/api/aeronaves', {
        method: 'POST',
        body: formData
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(data) {
                throw new Error(data.msg || 'Error al guardar la aeronave');
            });
        }
        return response.json();
    })
    .then(function(data) {
        // Cerrar modal
        var modalElement = document.getElementById('agregarAeronaveModal');
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
        
        // Refrescar lista de aeronaves
        loadAeronaves().then(function() {
            // Seleccionar la aeronave recién creada
            if (data.id) {
                document.getElementById('aeronave_id').value = data.id;
            }
            showMessage('Aeronave agregada exitosamente', 'success');
        });
    })
    .catch(function(error) {
        showMessage('Error al guardar aeronave: ' + error.message, 'danger');
    });
}

// Función para mostrar modal de agregar piloto
function showPilotoModal() {
    resetPilotoModalForm();
    var modal = new bootstrap.Modal(document.getElementById('agregarPilotoModal'));
    modal.show();
}

// Función para resetear formulario de piloto modal
function resetPilotoModalForm() {
    var form = document.getElementById('pilotoModalForm');
    form.reset();
    form.classList.remove('was-validated');
    // Establecer valores por defecto
    document.getElementById('modal_tipo_licencia').value = 'PPL';
    document.getElementById('modal_nacionalidad').value = 'México';
    document.getElementById('modal_horas_vuelo').value = '0';
}

// Función para validar formulario de piloto modal
function validatePilotoModalForm() {
    var form = document.getElementById('pilotoModalForm');
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return false;
    }
    return true;
}

// Función para guardar piloto desde modal
function guardarPilotoModal() {
    if (!validatePilotoModalForm()) {
        showMessage('Por favor complete los campos requeridos correctamente', 'warning');
        return;
    }
    
    var payload = {
        nombre: document.getElementById('modal_nombre').value.trim(),
        licencia: document.getElementById('modal_licencia').value.trim(),
        tipo_licencia: document.getElementById('modal_tipo_licencia').value,
        horas_vuelo: parseInt(document.getElementById('modal_horas_vuelo').value) || 0,
        nacionalidad: document.getElementById('modal_nacionalidad').value.trim()
    };
    
    fetch('/api/pilotos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(function(response) {
        if (!response.ok) {
            return response.json().then(function(data) {
                throw new Error(data.msg || 'Error al guardar el piloto');
            });
        }
        return response.json();
    })
    .then(function(data) {
        // Cerrar modal
        var modalElement = document.getElementById('agregarPilotoModal');
        var modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
        
        // Refrescar lista de pilotos
        loadPilotos().then(function() {
            // Seleccionar el piloto recién creado
            if (data.id) {
                document.getElementById('piloto_id').value = data.id;
            }
            showMessage('Piloto agregado exitosamente', 'success');
        });
    })
    .catch(function(error) {
        showMessage('Error al guardar piloto: ' + error.message, 'danger');
    });
}

// Event listener para previsualización de imagen en modal de aeronave
document.addEventListener('DOMContentLoaded', function() {
    // Preview de imagen en modal
    var modalImagenInput = document.getElementById('modal_imagen');
    if (modalImagenInput) {
        modalImagenInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            var preview = document.getElementById('modal_preview');
            var previewImg = document.getElementById('modal_image_preview');
            
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });
    }
    
    init();
});


// Funciones mejoradas con transiciones suaves
function showFormWithTransition(formId, title) {
    var form = document.getElementById(formId);
    if (!form) return;
    
    // Agregar clase para animación
    form.classList.remove('hiding');
    form.style.display = 'block';
    
    // Forzar reflow para activar animación
    void form.offsetWidth;
    
    form.classList.add('showing');
    
    // Actualizar título si existe
    var formTitle = document.getElementById('formTitle');
    if (formTitle && title) {
        formTitle.textContent = title;
    }
    
    // Scroll suave al formulario
    setTimeout(function() {
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

function hideFormWithTransition(formId) {
    var form = document.getElementById(formId);
    if (!form) return;
    
    // Agregar clase de salida
    form.classList.add('hiding');
    form.classList.remove('showing');
    
    // Ocultar después de la animación
    setTimeout(function() {
        form.style.display = 'none';
        form.classList.remove('hiding');
    }, 400); // Duración de la transición
    
    // Scroll suave al inicio
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

</script>
{% endblock %}

{% block content %}
<div class="container">
    <h3 class="my-4">Gestión de Vuelos</h3>
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <button class="btn btn-primary" onclick="showCreate()">
                <i class="fas fa-plus"></i> Nuevo vuelo
            </button>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="exportarPDF()">
                <i class="fas fa-file-pdf"></i> Exportar a PDF
            </button>
            <button class="btn btn-success" onclick="exportarExcel()">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Filtros</h5>
            <div class="row">
                <div class="col-md-2 col-sm-6 mb-3">
                    <label for="filtro_estado" class="form-label">Estátus</label>
                    <select class="form-select" id="filtro_estado">
                        <option value="">Todos</option>
                        <option value="Programado">Programado</option>
                        <option value="En Vuelo">En Vuelo</option>
                        <option value="Completado">Completado</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <label for="filtro_aeronave" class="form-label">Aeronave</label>
                    <select class="form-select" id="filtro_aeronave">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <label for="filtro_piloto" class="form-label">Piloto</label>
                    <select class="form-select" id="filtro_piloto">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <label for="filtro_fecha_desde" class="form-label">Fecha Desde</label>
                    <input type="date" class="form-control" id="filtro_fecha_desde">
                </div>
                <div class="col-md-2 col-sm-6 mb-3">
                    <label for="filtro_fecha_hasta" class="form-label">Fecha Hasta</label>
                    <input type="date" class="form-control" id="filtro_fecha_hasta">
                </div>
                <div class="col-md-2 col-sm-6 d-flex align-items-end mb-3">
                    <button class="btn btn-outline-primary w-100" onclick="aplicarFiltros()">
                        <i class="fas fa-filter"></i> Aplicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Vuelo -->
    <div class="card mb-4" id="formCard" form-container style="display: none;">
        <div class="card-body">
            <h4 class="card-title" id="formTitle">Nuevo Vuelo</h4>
            <form id="vueloForm">
                <input type="hidden" id="vuelo_id">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="numero_vuelo" class="form-label">Número de Vuelo *</label>
                        <input type="text" class="form-control" id="numero_vuelo" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="aeronave_id" class="form-label">Aeronave *</label>
                        <div class="input-group">
                            <select class="form-select" id="aeronave_id" required>
                                <option value="">Seleccione una aeronave</option>
                            </select>
                            <button class="btn btn-outline-primary" type="button" onclick="showAeronaveModal()" title="Agregar nueva aeronave">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="origen" class="form-label">Origen *</label>
                        <input type="text" class="form-control" id="origen" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="destino" class="form-label">Destino *</label>
                        <input type="text" class="form-control" id="destino" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fecha_salida" class="form-label">Fecha y Hora de Salida *</label>
                        <input type="datetime-local" class="form-control" id="fecha_salida" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="fecha_llegada" class="form-label">Fecha y Hora de Llegada *</label>
                        <input type="datetime-local" class="form-control" id="fecha_llegada" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="piloto_id" class="form-label">Piloto *</label>
                        <div class="input-group">
                            <select class="form-select" id="piloto_id" required>
                                <option value="">Seleccione un piloto</option>
                            </select>
                            <button class="btn btn-outline-primary" type="button" onclick="showPilotoModal()" title="Agregar nuevo piloto">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="copiloto_id" class="form-label">Copiloto</label>
                        <select class="form-select" id="copiloto_id">
                            <option value="">Seleccione un copiloto (opcional)</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="estado" class="form-label">Estatus actual *</label>
                        <select class="form-select" id="estado" required>
                            <option value="Programado">Programado</option>
                            <option value="En Vuelo">En Vuelo</option>
                            <option value="Completado">Completado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="pasajeros" class="form-label">
                            Pasajeros
                            <small class="text-muted">(Uno por línea)</small>
                        </label>
                        <textarea class="form-control" id="pasajeros" rows="3" 
                                  placeholder="Ingrese el nombre de cada pasajero en una línea separada&#10;Ejemplo:&#10;Juan Pérez&#10;María García&#10;Carlos López"></textarea>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" rows="3" 
                                  placeholder="Ingrese observaciones adicionales sobre el vuelo..."></textarea>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="hideForm()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Vuelos -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Salida</th>
                            <th>Llegada</th>
                            <th>Aeronave</th>
                            <th>Piloto</th>
                            <th>Copiloto</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="vuelosTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
<!-- Modal de éxito -->
<div class="modal fade" id="saveSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-check-circle text-success me-2"></i>Operación exitosa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="saveSuccessMessage">Cambios guardados correctamente.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Modal para Agregar Aeronave -->
<div class="modal fade" id="agregarAeronaveModal" tabindex="-1" aria-labelledby="agregarAeronaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agregarAeronaveModalLabel">
                    <i class="fas fa-plane me-2"></i>Agregar Nueva Aeronave
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="aeronaveModalForm" novalidate>
                    <div class="mb-3">
                        <label for="modal_matricula" class="form-label">Matrícula *</label>
                        <input type="text" class="form-control" id="modal_matricula" required 
                               pattern="[A-Z0-9-]+" maxlength="20" placeholder="Ej: XA-ABC">
                        <div class="invalid-feedback">
                            La matrícula es requerida (solo letras mayúsculas, números y guiones)
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_modelo" class="form-label">Modelo *</label>
                        <input type="text" class="form-control" id="modal_modelo" required 
                               maxlength="100" placeholder="Ej: Boeing 737">
                        <div class="invalid-feedback">
                            El modelo es requerido
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_fabricante" class="form-label">Fabricante</label>
                        <input type="text" class="form-control" id="modal_fabricante" 
                               maxlength="100" placeholder="Ej: Boeing">
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_capacidad" class="form-label">Capacidad</label>
                        <input type="number" class="form-control" id="modal_capacidad" 
                               min="1" max="999" placeholder="Ej: 180">
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_tipo_aeronave" class="form-label">Tipo de Aeronave</label>
                        <select class="form-select" id="modal_tipo_aeronave">
                            <option value="">Seleccione un tipo</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Carga">Carga</option>
                            <option value="Privada">Privada</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_imagen" class="form-label">Imagen de la Aeronave</label>
                        <input type="file" class="form-control" id="modal_imagen" accept="image/*">
                        <div id="modal_preview" class="mt-2" style="display: none;">
                            <img id="modal_image_preview" class="img-thumbnail" style="max-width: 200px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarAeronaveModal()">
                    <i class="fas fa-save me-1"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar Piloto -->
<div class="modal fade" id="agregarPilotoModal" tabindex="-1" aria-labelledby="agregarPilotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agregarPilotoModalLabel">
                    <i class="fas fa-user-tie me-2"></i>Agregar Nuevo Piloto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="pilotoModalForm" novalidate>
                    <div class="mb-3">
                        <label for="modal_nombre" class="form-label">Nombre Completo *</label>
                        <input type="text" class="form-control" id="modal_nombre" required 
                               maxlength="100" placeholder="Ej: Juan Pérez García">
                        <div class="invalid-feedback">
                            El nombre es requerido
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_licencia" class="form-label">Número de Licencia *</label>
                        <input type="text" class="form-control" id="modal_licencia" required 
                               maxlength="50" placeholder="Ej: ATP-12345">
                        <div class="invalid-feedback">
                            La licencia es requerida
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_tipo_licencia" class="form-label">Tipo de Licencia</label>
                        <select class="form-select" id="modal_tipo_licencia">
                            <option value="PPL" selected>PPL - Licencia de Piloto Privado</option>
                            <option value="CPL">CPL - Licencia de Piloto Comercial</option>
                            <option value="SPL">SPL - Licencia de Piloto Aviador Deportivo</option>
                            <option value="ATPL">ATPL - Licencia de Piloto de Transporte</option>
                            <option value="RPAS">RPAS - Licencia de Piloto de Drones</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_horas_vuelo" class="form-label">Horas de Vuelo</label>
                        <input type="number" class="form-control" id="modal_horas_vuelo" 
                               min="0" max="99999" placeholder="Ej: 1500" value="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal_nacionalidad" class="form-label">Nacionalidad</label>
                        <input type="text" class="form-control" id="modal_nacionalidad" 
                               maxlength="50" placeholder="Ej: México" value="México">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarPilotoModal()">
                    <i class="fas fa-save me-1"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Confirmar Vuelo -->
<div class="modal fade" id="confirmarVueloModal" tabindex="-1" aria-labelledby="confirmarVueloModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmarVueloModalLabel">
                    <i class="fas fa-check-circle text-success me-2"></i>Confirmar Vuelo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Información del Vuelo:</strong>
                </div>
                <div id="vueloInfo" class="mb-3">
                    <!-- La información del vuelo se cargará aquí dinámicamente -->
                </div>
                
                <form id="confirmarVueloForm">
                    <input type="hidden" id="vuelo_id_confirmar">
                    
                    <div class="mb-3">
                        <label for="estado_confirmacion" class="form-label">Estado de Confirmación *</label>
                        <select class="form-select" id="estado_confirmacion" required>
                            <option value="">Seleccione un estado</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notas_confirmacion" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notas_confirmacion" rows="3" 
                                placeholder="Ingrese cualquier observación o nota adicional..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="guardarConfirmacion()">
                    <i class="fas fa-save me-1"></i>Guardar Confirmación
                </button>
            </div>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/vuelos_confirmacion.js') }}"></script>
{% endblock %}